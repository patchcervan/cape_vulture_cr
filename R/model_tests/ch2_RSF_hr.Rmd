
## 2. Resource selection from occurrence

Here we fit a model considering availability to be in the surroundings of observed locations (option 2 in the introduction).

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# make amt xyt tracks
use_rdm <- tibble(
    bird_id =  test_data %>% 
    pull(bird_id),
    # Create a track_xyt data frame
    data = test_data %>% 
    pull(data) %>% 
    future_map(~ make_track(st_drop_geometry(.x), x, y, datetime, crs = crs(.x)))
)


# Define available area ---------------------------------------------------
use_rdm <- use_rdm %>% 
    mutate(av_area = future_map(use_rdm$data, ~ sf::st_buffer(hr_isopleths(hr_mcp(.x, levels = 1)), dist = 5000)))


# Generate random points --------------------------------------------------
future::plan("multiprocess")
use_rdm <- use_rdm$data %>% 
    future_map2(use_rdm$av_area, ~ random_points(.y, n = nrow(.x) * 5, presence = .x))
future::plan("sequential")


# Extract covariates ------------------------------------------------------
#source("../functions/extractCovts.R")
source("R/functions/extractCovts.R")

# Reproject use-available points and extract covariates
future::plan("multiprocess")
use_rdm <- use_rdm %>% 
    future_map2(test_data$tmerproj, ~ st_as_sf(.x, coords = c("x_", "y_"), remove = FALSE, crs = .y)) %>% 
    # calculate distance from colony
    future_map2(test_data$colony, ~mutate(.x, dist = as.numeric(st_distance(.x, .y)))) %>% 
    # extract other covariates
    future_map(~ st_transform(.x, crs = 4326)) %>% 
    future_map(~ extractCovts(.x))
future::plan("sequential")


# Fit model ---------------------------------------------------------------

# Standardize covariates and fit model
rsf_fits <- use_rdm %>% 
    future_map(~ mutate(.x, across(.cols = c("srtm", "slope", "vrm3", "dist"), scale))) %>% 
    future_map(~ fit_rsf(case_ ~ srtm + slope + vrm3 + dist, data = .x))

```

First, we show the plots of used vs. available points. We took a buffer of 5km around the minimum complex polygon enclosing the observed locations.

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='95%', fig.align='center', fig.show='hold', fig.cap="Observed vs. available"}

# Plot use vs available
op <- par()
par(mfrow = c(2,3))
for(i in seq_along(use_rdm)) plot(use_rdm[[i]])
par(op)

```


The fitted model is as follows:


```{r equation, echo=FALSE, results="asis"}

# Print model
equatiomatic::extract_eq(rsf_fits[[1]]$model)

```


The standardized coefficients for these adult birds are as follows:

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='95%', fig.align='center', fig.show='hold'}

# Extract coefficients
rsf_coeff <- rsf_fits %>% 
    map(~ as_tibble(summary(.x)$coefficients, rownames = "variable")) %>% 
    map2(test_data$bird_id, ~ mutate(.x, bird_id = .y)) %>% 
    map2(test_data %>% 
    left_join(dplyr::select(db, bird_id, age), by = "bird_id") %>% 
        pull(age), ~ mutate(.x, age = .y)) %>%
    do.call("rbind", .)

# Plot
rsf_coeff %>% 
    filter(variable != "(Intercept)") %>% 
    ggplot() +
    geom_pointrange(aes(x = variable, y = Estimate, 
                        ymin = Estimate - `Std. Error`, 
                        ymax = Estimate + `Std. Error`,
                        colour = age)) +
    geom_hline(aes(yintercept = 0), linetype = "dashed") +
    facet_grid(bird_id ~ .)
    
rsf_coeff %>% 
    filter(variable != "(Intercept)") %>% 
    ggplot() +
    geom_pointrange(aes(x = bird_id, y = Estimate, 
                        ymin = Estimate - `Std. Error`, 
                        ymax = Estimate + `Std. Error`,
                        colour = age)) +
    facet_grid(variable ~ ., scales = "free")
```


```{r, echo=FALSE}
# Save model ouputs
write_rds(rsf_fits, "output/rsf_hr_fits_test.rds")

```
